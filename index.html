<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Material Tracker</title>
  <style>
    /* Minimal, modern UI styles */
    :root{--accent:#2563eb;--card:#fff;--bg:#f3f4f6}
    body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#111}
    .container{max-width:1100px;margin:32px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:20px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=date], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
    button{background:var(--accent);color:white;padding:10px 12px;border:0;border-radius:8px;cursor:pointer}
    .small{font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .actions{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Material Tracker</h1>
      <div class="small">Simple web UI backed by Google Sheets</div>
    </header>

    <div class="grid">
      <!-- Left: Forms and Data -->
      <div>
        <div class="card">
          <h3>Record Inflow</h3>
          <div>
            <label>Date</label>
            <input id="in_date" type="date" />
            <label>Item</label>
            <select id="in_item"></select>
            <label>Quantity</label>
            <input id="in_qty" type="number" min="1" />
            <label>Vendor</label>
            <select id="in_vendor">
              <option>Vendor A</option>
              <option>Vendor B</option>
              <option>Vendor C</option>
            </select>
            <div style="margin-top:12px" class="actions">
              <button id="btnAddIn">Add Inflow</button>
              <button id="btnDownloadIn">Download CSV</button>
            </div>
            <div id="in_status" class="small" style="margin-top:8px;color:green"></div>
          </div>
        </div>

        <div style="height:20px"></div>

        <div class="card">
          <h3>Record Outflow</h3>
          <label>Date</label>
          <input id="out_date" type="date" />
          <label>Item</label>
          <select id="out_item"></select>
          <label>Quantity</label>
          <input id="out_qty" type="number" min="1" />
          <label>Buyer</label>
          <select id="out_buyer">
            <option>Buyer 1</option>
            <option>Buyer 2</option>
            <option>Buyer 3</option>
          </select>
          <div style="margin-top:12px" class="actions">
            <button id="btnAddOut">Add Outflow</button>
            <button id="btnDownloadOut">Download CSV</button>
          </div>
          <div id="out_status" class="small" style="margin-top:8px;color:green"></div>
        </div>
      </div>

      <!-- Right: Dashboard -->
      <div>
        <div class="card">
          <h3>Stock Summary</h3>
          <table id="summary_table"><thead><tr><th>Item</th><th>Stock</th></tr></thead><tbody></tbody></table>
          <div style="height:12px"></div>
          <button id="btnRefresh">Refresh</button>
        </div>

        <div style="height:20px"></div>

        <div class="card">
          <h3>Recent Inflow</h3>
          <table id="in_table"><thead><tr><th>Date</th><th>Item</th><th>Qty</th><th>Vendor</th></tr></thead><tbody></tbody></table>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h3>Recent Outflow</h3>
          <table id="out_table"><thead><tr><th>Date</th><th>Item</th><th>Qty</th><th>Buyer</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Replace with your Apps Script Web App URL (deployed web app URL)
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzqBZfbqAtA3X86_GcFTNvyrMq_A4aSJMMUZk5DSurNO1C1hCFnJxLuXVxs93Ks2xEv/exec';
    // If you enabled REQUIRE_API_KEY in Apps Script, set API_KEY here
    const API_KEY = 'false';

    // ---------- Helpers ----------
    async function apiGet(params) {
      if (API_KEY) params.key = API_KEY;
      const url = API_BASE + '?' + new URLSearchParams(params);
      const res = await fetch(url);
      return res.json();
    }

    // POST: send JSON as plain text to avoid CORS preflight
    async function apiPost(action, payload) {
      const keyParam = API_KEY ? '&key=' + encodeURIComponent(API_KEY) : '';
      const url = API_BASE + '?action=' + encodeURIComponent(action) + keyParam;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // <- avoids preflight
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    // ---------- UI Elements ----------
    const inItem = document.getElementById('in_item');
    const outItem = document.getElementById('out_item');
    const btnAddIn = document.getElementById('btnAddIn');
    const btnAddOut = document.getElementById('btnAddOut');
    const btnRefresh = document.getElementById('btnRefresh');
    const inTable = document.getElementById('in_table').querySelector('tbody');
    const outTable = document.getElementById('out_table').querySelector('tbody');
    const summaryTable = document.getElementById('summary_table').querySelector('tbody');

    // Populate items and initial data
    async function init() {
      await loadItems();
      await refreshAll();
    }

    async function loadItems() {
      try {
        const data = await apiGet({action:'getItems'});
        const items = (data.items && data.items.length) ? data.items : ['Apples','Bananas','Cherries','Jams','Yams'];
        inItem.innerHTML = outItem.innerHTML = '';
        items.forEach(it => {
          const o1 = document.createElement('option'); o1.textContent = it; o1.value = it; inItem.appendChild(o1);
          const o2 = document.createElement('option'); o2.textContent = it; o2.value = it; outItem.appendChild(o2);
        });
      } catch (err) { console.error(err); }
    }

    async function refreshAll() {
      try {
        const [inflowRes, outflowRes, summaryRes] = await Promise.all([
          apiGet({action:'getInflow'}),
          apiGet({action:'getOutflow'}),
          apiGet({action:'getSummary'})
        ]);
        renderTable(inTable, inflowRes.rows || []);
        renderTable(outTable, outflowRes.rows || []);
        renderSummary(summaryRes.summary || []);
      } catch (err) { console.error(err); }
    }

    function renderTable(tbody, rows) {
      tbody.innerHTML = '';
      const slice = rows.slice(-10).reverse(); // show recent 10
      slice.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.Date || ''}</td><td>${r.Item || ''}</td><td>${r.Quantity || ''}</td><td>${r.Vendor||r.Buyer||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderSummary(rows) {
      summaryTable.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.item}</td><td>${r.stock}</td>`;
        summaryTable.appendChild(tr);
      });
    }

    // ---------- Actions ----------
    btnAddIn.addEventListener('click', async () => {
      const payload = {
        date: document.getElementById('in_date').value || (new Date()).toISOString().slice(0,10),
        item: inItem.value,
        quantity: Number(document.getElementById('in_qty').value || 0),
        vendor: document.getElementById('in_vendor').value
      };
      if (!payload.item || !payload.quantity) { alert('Select item and quantity'); return; }
      const res = await apiPost('addinflow', payload);
      if (res.ok) {
        document.getElementById('in_status').textContent = 'Saved ✓';
        setTimeout(()=>document.getElementById('in_status').textContent='',1500);
        await refreshAll();
      } else alert('Error: ' + (res.error || JSON.stringify(res)));
    });

    btnAddOut.addEventListener('click', async () => {
      const payload = {
        date: document.getElementById('out_date').value || (new Date()).toISOString().slice(0,10),
        item: outItem.value,
        quantity: Number(document.getElementById('out_qty').value || 0),
        buyer: document.getElementById('out_buyer').value
      };
      if (!payload.item || !payload.quantity) { alert('Select item and quantity'); return; }
      const res = await apiPost('addoutflow', payload);
      if (res.ok) {
        document.getElementById('out_status').textContent = 'Saved ✓';
        setTimeout(()=>document.getElementById('out_status').textContent='',1500);
        await refreshAll();
      } else alert('Error: ' + (res.error || JSON.stringify(res)));
    });

    btnRefresh.addEventListener('click', refreshAll);

    // CSV download for inflow/outflow
    document.getElementById('btnDownloadIn').addEventListener('click', async () => {
      const res = await apiGet({action:'getInflow'});
      downloadCSV(res.rows || [], 'inflow.csv');
    });
    document.getElementById('btnDownloadOut').addEventListener('click', async () => {
      const res = await apiGet({action:'getOutflow'});
      downloadCSV(res.rows || [], 'outflow.csv');
    });

    function downloadCSV(rows, filename) {
      if (!rows.length) { alert('No rows'); return; }
      const headers = Object.keys(rows[0]);
      const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => '"' + (r[h]||'') + '"').join(','))).join('
');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    }

    // init
    init();
  </script>
</body>
</html>


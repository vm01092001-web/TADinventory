<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚ú® TAD.INVENTORY</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --bg1: #020617;
    --bg2: #081027;
    --glass: rgba(255,255,255,0.05);
    --accent: #00ffe7;
    --accent-2: #6b5cff;
    --muted: #9aa4b2;
    --ok: #34d399;
    --danger: #ff6b6b;
    --radius: 16px;
    --shadow: 0 12px 40px rgba(0,0,0,0.6);
    --neon-glow: 0 0 12px var(--accent), 0 0 24px var(--accent-2);
    --rabbit-blue: #1e90ff;
  }
  * { box-sizing: border-box; transition: all 0.3s ease; }
  html, body { height: 100%; margin: 0; background: linear-gradient(135deg, var(--bg1), var(--bg2)); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; color: #dfe7ee; }
  .app { display: flex; height: 100vh; gap: 24px; padding: 28px; background: radial-gradient(circle at top left, rgba(0,255,231,0.06), transparent); animation: fadeIn 1.2s ease; }
  .sidebar { width: 280px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius: 20px; padding: 24px; backdrop-filter: blur(14px); box-shadow: var(--shadow), var(--neon-glow); border: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; }
  .sidebar:hover { transform: scale(1.03); }
  .brand { font-family: Orbitron, system-ui; font-weight: 700; color: var(--accent); font-size: 22px; letter-spacing: 1px; text-align: center; margin-bottom: 20px; text-shadow: var(--neon-glow); animation: pulse 2.5s infinite; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .nav { display: flex; flex-direction: column; gap: 12px; }
  .nav .item { padding: 14px; border-radius: 12px; color: #dfe7ee; cursor: pointer; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.3); font-weight: 500; }
  .nav .item:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(0,255,231,0.12); background: rgba(255,255,255,0.06); color: var(--accent); }
  .nav .item.active { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #001; font-weight: 700; box-shadow: 0 8px 32px rgba(0,255,231,0.2); }
  .who { margin-top: auto; font-size: 14px; color: var(--muted); padding-top: 14px; border-top: 1px solid rgba(255,255,255,0.03); text-align: center; }
  .login-box { display: flex; flex-direction: column; gap: 10px; margin-top: 14px; }
  .login-box input { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.06); padding: 12px; border-radius: 12px; color: #fff; }
  .login-box input:focus { border-color: var(--accent); outline: none; box-shadow: var(--neon-glow); }
  .btn { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #001; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
  .btn:hover { transform: scale(1.05); box-shadow: var(--neon-glow); }
  .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--muted); }
  .btn.ghost:hover { border-color: var(--accent); color: var(--accent); box-shadow: var(--neon-glow); }
  .main { flex: 1; display: flex; flex-direction: column; gap: 20px; }
  .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .search { flex: 1; display: flex; gap: 10px; align-items: center; }
  .search input { flex: 1; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); color: #fff; }
  .search input:focus { border-color: var(--accent); outline: none; box-shadow: var(--neon-glow); }
  .cards { display: grid; grid-template-columns: repeat(2,1fr); gap: 20px; }
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius: 16px; padding: 20px; box-shadow: var(--shadow), var(--neon-glow); border: 1px solid rgba(255,255,255,0.05); }
  .card:hover { transform: scale(1.02); }
  .card h3 { margin: 0; font-size: 16px; color: var(--muted); font-weight: 600; }
  .card .big { font-size: 32px; margin-top: 10px; color: var(--accent); font-weight: 800; text-shadow: var(--neon-glow); }
  .panel { display: flex; gap: 20px; }
  .panel-left { flex: 1; display: flex; flex-direction: column; gap: 15px; }
  .panel-right { width: 420px; }
  .form-row { display: flex; gap: 12px; }
  .form-row input, .form-row select { flex: 1; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); color: #fff; }
  .form-row input:focus, .form-row select:focus { border-color: var(--accent); outline: none; box-shadow: var(--neon-glow); }
  .small { font-size: 14px; color: var(--muted); }
  table { width: 100%; border-collapse: collapse; color: #e9f2f7; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
  tr:hover { background: rgba(255,255,255,0.03); }
  th { color: var(--muted); font-weight: 600; }
  .status.pending { color: var(--accent); font-weight: 600; }
  .status.approved { color: var(--ok); font-weight: 600; }
  .status.rejected { color: var(--danger); font-weight: 600; }
  .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 100; backdrop-filter: blur(8px); }
  .modal .box { width: 840px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius: 16px; padding: 20px; box-shadow: 0 40px 120px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.05); animation: popIn 0.3s ease; }
  .muted { color: var(--muted); font-size: 14px; }
  .neon { color: var(--accent); text-shadow: 0 4px 22px rgba(0,255,231,0.15); }
  .loading-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); z-index: 200; }
  .loading-overlay.show { display: flex; }
  .rabbit { width: 80px; height: 80px; background: var(--rabbit-blue); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: relative; animation: hop 1s infinite; }
  .rabbit::before { content: ''; position: absolute; top: -20px; left: 10px; width: 20px; height: 40px; background: var(--rabbit-blue); border-radius: 50%; transform: rotate(20deg); }
  .rabbit::after { content: ''; position: absolute; top: -20px; right: 10px; width: 20px; height: 40px; background: var(--rabbit-blue); border-radius: 50%; transform: rotate(-20deg); }
  .fact { color: var(--accent); font-size: 18px; text-align: center; margin-top: 20px; text-shadow: var(--neon-glow); max-width: 600px; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
  @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
  @media (max-width: 1100px) { .cards { grid-template-columns: repeat(2,1fr); } .panel-right { display: none; } }
  @media (max-width: 760px) { 
    .app { flex-direction: column; padding: 12px; } 
    .sidebar { width: 100%; flex-direction: row; gap: 12px; overflow: auto; padding: 12px; } 
    .cards { grid-template-columns: 1fr; } 
    .main { padding: 12px; } 
    .brand { font-size: 18px; letter-spacing: 0.5px; } 
  }
  .toast { position: fixed; right: 28px; bottom: 28px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); padding: 14px 20px; border-radius: 12px; color: #001; font-weight: 700; box-shadow: 0 8px 30px rgba(0,0,0,0.6); opacity: 0; }
  .toast.show { opacity: 1; animation: popIn 0.3s ease; }
</style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">TAD.INVENTORY</div>
      <nav class="nav" id="nav">
        <div class="item active" data-tab="items">üì¶ Items</div>
        <div class="item" data-tab="stock">üîç Stock</div>
        <div class="item" data-tab="inflow">‚¨Ü Inflow</div>
        <div class="item" data-tab="outflow">‚¨á Outflow</div>
        <div class="item admin-only" data-tab="requests" style="display:none">‚ö° Requests</div>
        <div class="item" data-tab="analytics">üìä Analytics</div>
      </nav>
      <div class="who" id="who">Not signed</div>
      <div class="login-box">
        <input id="loginUser" placeholder="Username">
        <input id="loginPass" type="password" placeholder="Password">
        <div style="display:flex;gap:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnLogout" class="btn ghost" style="display:none">Logout</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="globalSearch" placeholder="Search items, requests, users..." oninput="applySearch(this.value)">
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Live</div>
          <div class="neon" id="clock">--:--</div>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <h3>Total Items</h3>
          <div class="big" id="totalItems">--</div>
          <div class="muted">Items in master list</div>
        </div>
        <div class="card">
          <h3>Pending Requests</h3>
          <div class="big" id="pendingCount">--</div>
          <div class="muted">Requests awaiting approval</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-left">
          <!-- Items Tab -->
          <div id="tab-items" class="card tab">
            <h3>Manage Items</h3>
            <div class="form-row" style="margin-top:12px">
              <input id="newItem" placeholder="Add new item name">
              <button id="btnAddItem" class="btn">Add</button>
            </div>
            <p class="muted" id="addItemMsg"></p>
            <div style="margin-top:14px">
              <h3 class="muted">Master List</h3>
              <table id="itemsTable">
                <thead><tr><th>Item</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Stock Tab -->
          <div id="tab-stock" class="card tab" style="display:none">
            <h3>Inventory Stock</h3>
            <div style="margin-top:14px">
              <h3 class="muted">Current Stock Levels</h3>
              <table id="stockTable">
                <thead><tr><th>Item</th><th>Remaining</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Inflow Tab -->
          <div id="tab-inflow" class="card tab" style="display:none">
            <h3>Submit Inflow Request</h3>
            <label class="small muted">Date</label>
            <input id="inRequestDate" type="date">
            <div id="inRows" style="margin-top:12px"></div>
            <div style="display:flex;gap:10px;margin-top:12px">
              <button id="btnAddInRow" class="btn">+ Add Item Row</button>
              <button id="btnSubmitIn" class="btn" style="background:var(--accent-2)">Submit Inflow</button>
            </div>
            <p class="muted" id="inMsg"></p>
          </div>

          <!-- Outflow Tab -->
          <div id="tab-outflow" class="card tab" style="display:none">
            <h3>Submit Outflow Request</h3>
            <label class="small muted">Date</label>
            <input id="outRequestDate" type="date">
            <label class="small muted" style="margin-top:8px">Item</label>
            <select id="outItem"></select>
            <label class="small muted" style="margin-top:8px">Total Quantity</label>
            <input id="outTotal" type="number" min="1">
            <label class="small muted" style="margin-top:8px">Location</label>
            <input id="outLocation" placeholder="Location (e.g., Warehouse A)">
            <h4 class="muted" style="margin-top:12px">Receivers</h4>
            <div id="receivers"></div>
            <div style="display:flex;gap:10px;margin-top:12px">
              <button id="btnAddReceiver" class="btn">+ Add Receiver</button>
              <button id="btnSubmitOut" class="btn" style="background:var(--accent-2)">Submit Outflow</button>
            </div>
            <p class="muted" id="outMsg"></p>
          </div>

          <!-- Requests Tab (admin) -->
          <div id="tab-requests" class="card tab" style="display:none">
            <h3>Requests Dashboard (Admin)</h3>
            <div style="display:flex;gap:8px;margin-top:10px">
              <input id="filterItem" placeholder="Filter item" class="small">
              <input id="filterUser" placeholder="Filter user" class="small">
              <button id="btnApplyFilters" class="btn ghost">Apply</button>
            </div>
            <div style="margin-top:12px">
              <table id="requestsTable">
                <thead><tr><th>Req. ID</th><th>Submitted By</th><th>Items</th><th>Status</th><th>Action</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="tab-analytics" class="card tab" style="display:none">
            <h3>Inventory Flow Analytics</h3>
            <canvas id="trendChart" height="180"></canvas>
            <div class="muted" style="margin-top:8px">Inflow, Outflow, and Net Flow (last 5 days)</div>
          </div>
        </div>

        <div class="panel-right">
          <div class="card">
            <h3>Analytics Snapshot</h3>
            <canvas id="snapshotChart" height="180"></canvas>
            <div class="muted" style="margin-top:8px">Quick flow overview</div>
          </div>
          <div class="card" style="margin-top:12px">
            <h3>Quick Actions</h3>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn" onclick="loadItems()">Refresh Items</button>
              <button class="btn ghost" onclick="loadPending()">Refresh Pending</button>
              <button class="btn ghost" onclick="loadStock()">Refresh Stock</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Placeholder -->
  <div id="modalRoot"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
      <div class="rabbit"></div>
      <div id="randomFact" class="fact">Loading...</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="display:none" class="toast">Saved</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzBS3dDRn6mzKeAYLP18vr2EntM-rGUwWAj8166hUOd0QkIrtB8b11iQVO_8Ok-jWn_rA/exec"; // Your Apps Script URL

/* Random Facts */
const facts = [
  "A group of rabbits is called a fluffle!",
  "The shortest war in history lasted 38 minutes.",
  "Octopuses have three hearts and can change color to blend in.",
  "Honey never spoils; archeologists found edible honey in ancient tombs.",
  "A single lightning bolt can heat the air to 30,000¬∞C."
];

/* Session State */
let sessionCredentials = null; // Store username and password temporarily in memory

/* ================== Utils ================== */
function $(id) { return document.getElementById(id); }
function toast(msg, ms = 2500) {
  const t = $('toast');
  t.innerText = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}
function nowISO() { return new Date().toISOString().slice(0,10); }
function getSession() { return JSON.parse(localStorage.getItem('session') || 'null'); }
function setSession(s) { localStorage.setItem('session', JSON.stringify({ user: s.user, isAdmin: s.isAdmin })); }
function clearSession() {
  localStorage.removeItem('session');
  sessionCredentials = null; // Clear credentials on logout
}
function escapeHTML(str) { return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[m]); }
function showLoading() {
  $('loadingOverlay').classList.add('show');
  $('randomFact').innerText = facts[Math.floor(Math.random() * facts.length)];
}
function hideLoading() { $('loadingOverlay').classList.remove('show'); }

/* Simple POST wrapper */
async function post(data) {
  console.log('Sending POST request:', data); // Debug: Log request payload
  try {
    const session = getSession();
    if (!session && data.action !== 'login') {
      console.warn('No session for action:', data.action);
      throw new Error('Not authenticated');
    }
    if (session && data.action !== 'login') {
      if (!sessionCredentials) {
        console.warn('No credentials stored, prompting for password');
        const password = prompt('Re-enter password for ' + session.user) || '';
        sessionCredentials = { username: session.user, password };
      }
      data.username = sessionCredentials.username;
      data.password = sessionCredentials.password;
    }
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // Avoid CORS preflight
      body: JSON.stringify(data)
    });
    console.log('POST response status:', res.status); // Debug: Log response status
    if (!res.ok) {
      const text = await res.text();
      console.error('Response error:', text);
      throw new Error(`HTTP error! Status: ${res.status}, Response: ${text}`);
    }
    const result = await res.json();
    console.log('POST response data:', result); // Debug: Log response data
    if (result.error === 'bad auth') {
      console.warn('Bad auth, clearing session');
      clearSession();
      initSession();
      toast('Session expired, please log in again');
      sessionCredentials = null; // Clear credentials on bad auth
    }
    return result;
  } catch (err) {
    console.error('POST error:', err); // Debug: Log errors
    toast('Network error: ' + err.message);
    throw err;
  }
}

async function get(url) {
  console.log('Sending GET request:', url); // Debug: Log request URL
  try {
    const res = await fetch(API_URL + url);
    console.log('GET response status:', res.status); // Debug: Log response status
    if (!res.ok) {
      const text = await res.text();
      console.error('GET response error:', text);
      throw new Error(`HTTP error! Status: ${res.status}, Response: ${text}`);
    }
    const result = await res.json();
    console.log('GET response data:', result); // Debug: Log response data
    return result;
  } catch (err) {
    console.error('GET error:', err); // Debug: Log errors
    toast('Network error: ' + err.message);
    throw err;
  }
}

/* ================== UI Wiring ================== */
const navItems = document.querySelectorAll('.nav .item');
navItems.forEach(n => n.addEventListener('click', () => {
  navItems.forEach(x => x.classList.remove('active'));
  n.classList.add('active');
  showTab(n.dataset.tab);
}));

function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
  $(`tab-${tab}`).style.display = 'block';
  if (tab === 'stock') loadStock();
  if (tab === 'analytics') loadFlowData();
}
showTab('items'); // Initial tab

/* Clock */
setInterval(() => { $('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

/* Initialize session state */
function initSession() {
  const session = getSession();
  if (session) {
    $('who').innerText = `Signed as ${session.user}${session.isAdmin ? ' (admin)' : ''}`;
    $('btnLogin').style.display = 'none';
    $('btnLogout').style.display = 'inline-block';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = session.isAdmin ? 'block' : 'none');
    loadItems();
    loadPendingCount();
    loadFlowData();
  } else {
    $('who').innerText = 'Not signed';
    $('btnLogin').style.display = 'inline-block';
    $('btnLogout').style.display = 'none';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
  }
}
initSession();

/* ================== AUTH ================== */
$('btnLogin').addEventListener('click', async () => {
  const u = $('loginUser').value.trim();
  const p = $('loginPass').value.trim();
  console.log('Login attempt:', { username: u, password: '****' }); // Debug: Mask password
  if (!u || !p) {
    toast('Enter username and password');
    console.warn('Login failed: Empty username or password');
    return;
  }
  showLoading();
  try {
    const r = await post({ action: 'login', username: u, password: p });
    hideLoading();
    if (r.success) {
      sessionCredentials = { username: u, password: p }; // Store credentials in memory
      setSession({ user: u, isAdmin: r.isAdmin || false });
      $('who').innerText = `Signed as ${u}${r.isAdmin ? ' (admin)' : ''}`;
      $('btnLogin').style.display = 'none';
      $('btnLogout').style.display = 'inline-block';
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = r.isAdmin ? 'block' : 'none');
      toast('Welcome, ' + u);
      await loadItems();
      await loadPendingCount();
      await loadFlowData();
    } else {
      toast(r.error || 'Login failed');
      console.warn('Login failed:', r.error);
    }
  } catch (err) {
    hideLoading();
    toast('Network error');
    console.error('Login error:', err);
  }
});

$('btnLogout').addEventListener('click', () => {
  clearSession();
  initSession();
  toast('Logged out');
});

/* ================== ITEMS ================== */
async function loadItems() {
  try {
    const r = await get('?action=getItems');
    if (!r.success) {
      toast(r.error || 'Failed to load items');
      return;
    }
    const items = r.items || [];
    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = '';
    items.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHTML(it)}</td>`;
      tbody.appendChild(tr);
    });
    $('totalItems').innerText = items.length;
    // Populate selects
    const itemOptions = `<option value="">Select</option>` + items.map(i => `<option>${escapeHTML(i)}</option>`).join('');
    $('outItem').innerHTML = itemOptions;
    document.querySelectorAll('#inRows select.itemSel').forEach(sel => {
      const old = sel.value;
      sel.innerHTML = itemOptions;
      if (old) sel.value = old;
    });
  } catch (err) {
    toast('Unable to load items');
  }
}

/* Add item */
$('btnAddItem').addEventListener('click', async () => {
  const nm = $('newItem').value.trim();
  if (!nm) {
    $('addItemMsg').innerText = 'Enter item name';
    return;
  }
  try {
    const r = await post({ action: 'addItem', itemName: nm });
    if (r.success) {
      $('addItemMsg').innerText = 'Added ‚úì';
      $('newItem').value = '';
      await loadItems();
      toast('Item added');
    } else {
      $('addItemMsg').innerText = r.error || 'Error';
    }
  } catch (err) {
    $('addItemMsg').innerText = 'Network error';
  }
});

/* ================== STOCK ================== */
async function loadStock() {
  try {
    const r = await get('?action=getStock');
    if (!r.success) {
      toast(r.error || 'Failed to load stock');
      return;
    }
    const stock = r.stock || [];
    const tbody = document.querySelector('#stockTable tbody');
    tbody.innerHTML = '';
    stock.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHTML(it.item)}</td><td>${it.remaining}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    toast('Unable to load stock');
  }
}

/* ================== INFLOW FORM ================== */
$('btnAddInRow').addEventListener('click', () => addInRow());
function addInRow(pref = {}) {
  const container = $('inRows');
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.gap = '8px';
  row.style.marginTop = '8px';
  row.innerHTML = `
    <select class="itemSel" style="flex:2;"><option value="">Select</option></select>
    <input class="inQty" type="number" min="1" placeholder="Qty" style="flex:1;" value="${pref.quantity || 1}">
    <input class="inParty" placeholder="Party" style="flex:1" value="${pref.party || ''}">
    <button class="btn ghost btnRemoveRow" style="flex:0">‚úï</button>
  `;
  container.appendChild(row);
  get('?action=getItems').then(r => {
    if (r.success) {
      const opts = `<option value="">Select</option>` + r.items.map(i => `<option>${escapeHTML(i)}</option>`).join('');
      row.querySelector('select.itemSel').innerHTML = opts;
      if (pref.item) row.querySelector('select.itemSel').value = pref.item;
    }
  });
  row.querySelector('.btnRemoveRow').addEventListener('click', () => row.remove());
}
$('btnAddInRow').click(); // Initial row

$('btnSubmitIn').addEventListener('click', async () => {
  const date = $('inRequestDate').value || nowISO();
  const rows = Array.from(document.querySelectorAll('#inRows > div'));
  const items = rows.map(r => ({
    date,
    item: r.querySelector('select.itemSel').value,
    quantity: Number(r.querySelector('.inQty').value || 0),
    party: r.querySelector('.inParty').value.trim(),
    location: ''
  })).filter(x => x.item && x.quantity > 0);
  if (items.length === 0) {
    $('inMsg').innerText = 'Add valid rows';
    return;
  }
  try {
    const r = await post({ action: 'submitRequest', type: 'inflow', items });
    if (r.success) {
      $('inMsg').innerText = 'Submitted ‚úì';
      toast('Inflow request submitted');
      $('inRows').innerHTML = '';
      addInRow();
      $('inRequestDate').value = '';
      loadPendingCount();
      loadFlowData();
    } else {
      $('inMsg').innerText = r.error || 'Error';
    }
  } catch (err) {
    $('inMsg').innerText = 'Network error';
  }
});

/* ================== OUTFLOW FORM ================== */
$('btnAddReceiver').addEventListener('click', () => addReceiver());
function addReceiver(pref = {}) {
  const container = $('receivers');
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.gap = '8px';
  row.style.marginTop = '8px';
  row.innerHTML = `
    <input class="recvName" placeholder="Receiver" style="flex:2;" value="${pref.name || ''}">
    <input class="recvQty" type="number" min="1" placeholder="Qty" style="flex:1;" value="${pref.quantity || 1}">
    <button class="btn ghost btnRemove" style="flex:0">‚úï</button>
  `;
  container.appendChild(row);
  row.querySelector('.btnRemove').addEventListener('click', () => row.remove());
}
addReceiver();

$('btnSubmitOut').addEventListener('click', async () => {
  const date = $('outRequestDate').value || nowISO();
  const item = $('outItem').value;
  const total = Number($('outTotal').value || 0);
  const location = $('outLocation').value.trim();
  if (!item || total <= 0 || !location) {
    $('outMsg').innerText = 'Item, total, and location required';
    return;
  }
  const recs = Array.from(document.querySelectorAll('#receivers > div')).map(r => ({
    name: r.querySelector('.recvName').value.trim(),
    quantity: Number(r.querySelector('.recvQty').value || 0)
  })).filter(x => x.name && x.quantity > 0);
  const sumQty = recs.reduce((sum, r) => sum + r.quantity, 0);
  if (sumQty !== total) {
    $('outMsg').innerText = `Receiver quantities (${sumQty}) must match total (${total})`;
    return;
  }
  if (recs.length === 0) {
    $('outMsg').innerText = 'Add receivers';
    return;
  }
  const items = recs.map(r => ({ date, item, quantity: r.quantity, party: r.name, location }));
  try {
    const r = await post({ action: 'submitRequest', type: 'outflow', items });
    if (r.success) {
      $('outMsg').innerText = 'Submitted ‚úì';
      toast('Outflow request submitted');
      $('receivers').innerHTML = '';
      addReceiver();
      $('outTotal').value = '';
      $('outLocation').value = '';
      loadPendingCount();
      loadFlowData();
    } else {
      $('outMsg').innerText = r.error || 'Error';
    }
  } catch (err) {
    $('outMsg').innerText = 'Network error';
  }
});

/* ================== PENDING REQUESTS (Admin) ================== */
async function loadPending() {
  try {
    const session = getSession();
    if (!session || !session.isAdmin) {
      toast('Admin only');
      return;
    }
    const r = await post({ action: 'listPending' });
    if (!r.success) {
      toast(r.error || 'Failed to load pending');
      return;
    }
    renderPending(r.pending || []);
  } catch (err) {
    toast('Network error');
  }
}

async function loadPendingCount() {
  try {
    const session = getSession();
    if (!session || !session.isAdmin) {
      $('pendingCount').innerText = '--';
      return;
    }
    const r = await post({ action: 'listPending' });
    if (r.success) {
      $('pendingCount').innerText = (r.pending || []).length;
    } else {
      $('pendingCount').innerText = '--';
    }
  } catch (err) {
    console.warn('loadPendingCount error:', err);
  }
}

function renderPending(list) {
  const tbody = document.querySelector('#requestsTable tbody');
  tbody.innerHTML = '';
  list.forEach(req => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(req.requestId)}</td>
      <td>${escapeHTML(req.submittedBy)}</td>
      <td>${escapeHTML(req.items.map(i => `${i.item} x${i.quantity}`).join(', '))}</td>
      <td class="status ${req.status && req.status.toLowerCase()}">${escapeHTML(req.status)}</td>
      <td>
        <button class="btn" data-id="${escapeHTML(req.requestId)}" data-action="approve">Approve</button>
        <button class="btn ghost" data-id="${escapeHTML(req.requestId)}" data-action="reject">Reject</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id, action = btn.dataset.action;
      try {
        const r = await post({ action: 'actOnRequest', requestId: id, decision: action });
        if (r.success) {
          toast(`${action.charAt(0).toUpperCase() + action.slice(1)}ed ${r.processed} rows`);
          loadPending();
          loadPendingCount();
          loadFlowData();
        } else {
          toast(r.error || 'Error');
        }
      } catch (err) {
        toast('Network error');
      }
    });
  });
}

/* ================== Search & Filters ================== */
function applySearch(s) {
  s = (s || '').toLowerCase();
  document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(s) ? '' : 'none';
  });
  document.querySelectorAll('#stockTable tbody tr').forEach(tr => {
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(s) ? '' : 'none';
  });
  document.querySelectorAll('#requestsTable tbody tr').forEach(tr => {
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(s) ? '' : 'none';
  });
}

/* ================== Chart ================== */
let trendChart = null;
let snapshotChart = null;

async function loadFlowData() {
  try {
    const r = await get('?action=getFlowData');
    if (!r.success) {
      toast(r.error || 'Failed to load flow data');
      console.warn('Failed to load flow data:', r.error);
      return;
    }
    const { labels, inflows, outflows, totalFlow } = r.flow;
    console.log('Flow data loaded:', { labels, inflows, outflows, totalFlow }); // Debug

    // Main Analytics Chart
    if (trendChart) trendChart.destroy();
    trendChart = new Chart($('trendChart').getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Inflow',
            data: inflows,
            borderColor: 'rgba(0, 255, 231, 0.8)',
            backgroundColor: 'rgba(0, 255, 231, 0.2)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Outflow',
            data: outflows,
            borderColor: 'rgba(255, 107, 107, 0.8)',
            backgroundColor: 'rgba(255, 107, 107, 0.2)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Net Flow',
            data: totalFlow,
            borderColor: 'rgba(107, 92, 255, 0.8)',
            backgroundColor: 'rgba(107, 92, 255, 0.2)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Quantity', color: '#9aa4b2' } },
          x: { title: { display: true, text: 'Date', color: '#9aa4b2' } }
        },
        plugins: {
          legend: { labels: { color: '#9aa4b2' } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#00ffe7', bodyColor: '#fff' }
        }
      }
    });

    // Snapshot Chart (Right Panel)
    if (snapshotChart) snapshotChart.destroy();
    snapshotChart = new Chart($('snapshotChart').getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Inflow',
            data: inflows,
            borderColor: 'rgba(0, 255, 231, 0.8)',
            backgroundColor: 'rgba(0, 255, 231, 0.2)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Outflow',
            data: outflows,
            borderColor: 'rgba(255, 107, 107, 0.8)',
            backgroundColor: 'rgba(255, 107, 107, 0.2)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Net Flow',
            data: totalFlow,
            borderColor: 'rgba(107, 92, 255, 0.8)',
            backgroundColor: 'rgba(107, 92, 255, 0.2)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Quantity', color: '#9aa4b2' } },
          x: { title: { display: true, text: 'Date', color: '#9aa4b2' } }
        },
        plugins: {
          legend: { labels: { color: '#9aa4b2' } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#00ffe7', bodyColor: '#fff' }
        }
      }
    });
  } catch (err) {
    toast('Unable to load flow data');
    console.error('loadFlowData error:', err);
  }
}
</script>
</body>
</html>